<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="ModuleHolon">
  <BehaviorTree ID="ModuleHolon">
    <Sequence name="ModuleHolonRoot">
      <ReadConfig name="LoadConfig" configPath="configs/module_holon.json" />
      <SetBlackboardValue name="BindAgentId" Key="AgentId" Value="{config.Agent.AgentId}" />
      <SetBlackboardValue name="BindAgentRole" Key="AgentRole" Value="{config.Agent.Role}" />
      <SetBlackboardValue name="BindModuleId" Key="ModuleId" Value="{config.Agent.ModuleId}" />
      <SetBlackboardValue name="BindNamespace" Key="Namespace" Value="{config.Namespace}" />

      <ConnectToMessagingBroker
        name="ConnectMqtt"
        BrokerHost="{config.MQTT.Broker}"
        BrokerPort="{config.MQTT.Port}"
        DefaultTopic="{config.MQTT.TopicPrefix}/moduleholon"
        TimeoutMs="10000"
        ClientId="{config.Agent.AgentId}_ModuleHolon" />

      <ModuleHolonRegistration name="InitialRegistration" />
      <SubscribeModuleHolonTopics name="SubscribeTopics" />
      <SpawnSubHolons name="SpawnSubHolons" />
      <WaitForSubHolonRegister name="WaitSubHolon" TimeoutSeconds="20" />

      <Parallel name="HolonLoops">
        <Repeat name="OfferLoop" num_cycles="-1">
          <Fallback name="OfferOrIdle">
            <Sequence name="HandleOffer">
              <WaitForMessage name="AwaitOffer" ExpectedTypes="callForProposal,offerRequest" TimeoutSeconds="10" />
              <ForwardToInternal name="ForwardOffer" TargetTopic="/ModuleHolon/{ModuleId}/Planning/OfferRequest" />
              <WaitForInternalResponse name="AwaitOfferResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplyOffer" ResponseTopicTemplate="/DispatchingAgent/{Namespace}/ModuleOffers/{ModuleId}/Response/" />
              <Wait name="OfferIdle" DelayMs="150" />
            </Sequence>
            <Wait name="OfferBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="ScheduleLoop" num_cycles="-1">
          <Fallback name="ScheduleOrIdle">
            <Sequence name="HandleSchedule">
              <WaitForMessage name="AwaitSchedule" ExpectedTypes="scheduleAction" TimeoutSeconds="10" />
              <ForwardToInternal name="ForwardSchedule" TargetTopic="/ModuleHolon/{ModuleId}/Planning/ScheduleAction" />
              <WaitForInternalResponse name="AwaitScheduleResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplySchedule" ResponseTopicTemplate="/Modules/{ModuleId}/BookingConfirmation/" />
              <Wait name="ScheduleIdle" DelayMs="200" />
            </Sequence>
            <Wait name="ScheduleBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="TransportLoop" num_cycles="-1">
          <Fallback name="TransportOrIdle">
            <Sequence name="HandleTransport">
              <WaitForMessage name="AwaitTransport" ExpectedTypes="transportRequest,requestTransportPlan" TimeoutSeconds="10" />
              <ForwardToInternal name="ForwardTransport" TargetTopic="/ModuleHolon/{ModuleId}/Planning/TransportRequest" />
              <WaitForInternalResponse name="AwaitTransportResp" TimeoutSeconds="10" />
              <ReplyToDispatcher name="ReplyTransport" ResponseTopicTemplate="/Modules/{ModuleId}/TransportPlan/" />
              <Wait name="TransportIdle" DelayMs="200" />
            </Sequence>
            <Wait name="TransportBackoff" DelayMs="200" />
          </Fallback>
        </Repeat>

        <Repeat name="HeartbeatLoop" num_cycles="-1">
          <Sequence name="Heartbeat">
            <ModuleHolonRegistration name="RefreshRegistration" />
            <Wait name="HeartbeatWait" DelayMs="5000" />
          </Sequence>
        </Repeat>
      </Parallel>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Action ID="ReadConfig">
      <input_port name="configPath" />
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost" />
      <input_port name="BrokerPort" />
      <input_port name="DefaultTopic" />
      <input_port name="TimeoutMs" />
      <input_port name="ClientId" />
    </Action>
    <Action ID="ModuleHolonRegistration" />
    <Action ID="SubscribeModuleHolonTopics" />
    <Action ID="WaitForSubHolonRegister">
      <input_port name="TimeoutSeconds" default="20" />
    </Action>
    <Action ID="WaitForMessage">
      <input_port name="ExpectedType" />
      <input_port name="ExpectedTypes" />
      <input_port name="ExpectedSender" />
      <input_port name="TimeoutSeconds" />
      <input_port name="ExpectedConversationId" />
    </Action>
    <Action ID="ForwardToInternal">
      <input_port name="TargetTopic" />
    </Action>
    <Action ID="WaitForInternalResponse">
      <input_port name="TimeoutSeconds" default="10" />
    </Action>
    <Action ID="ReplyToDispatcher">
      <input_port name="ResponseTopicTemplate" />
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000" />
    </Action>
  </TreeNodesModel>
</root>
