<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="PlanningAgent">
  <BehaviorTree ID="PlanningAgent">
    <Sequence name="PlanningAgentRoot">
      <ConnectToMessagingBroker name="ConnectMqtt" BrokerHost="{config.MQTT.Broker}" BrokerPort="{config.MQTT.Port}" DefaultTopic="factory/agents/messages" TimeoutMs="10000" ClientId="{config.Agent.ModuleName}_PlanningAgent" />
      <SetBlackboardValue name="SetPlanningRole" Key="AgentRole" Value="PlanningAgent" />
      <SetBlackboardValue name="SetPlanningId" Key="AgentId" Value="{config.Agent.ModuleName}_Planning" />
      <RegisterSubHolon name="RegisterPlanning" />
      
      <Parallel name="PlanningParallel">
        <Repeat name="RegistrationHeartbeat" num_cycles="-1">
          <Sequence name="RegistrationBeat">
            <RegisterSubHolon name="RegisterPlanningHeartbeat" />
            <Wait name="RegistrationWait" DelayMs="5000" />
          </Sequence>
        </Repeat>
        <Repeat name="PlanOfferLoop" num_cycles="-1">
          <Fallback name="PlanOrRefusal">
            <Sequence name="PlanSequence">
              <ReceiverRequestForOffer name="ReceiveOfferReq" RequiredCapability="{ActionTitle}" />
              <CapabilityMatchmaking name="MatchCapability" RequiredCapability="{RequiredCapability}" />
              <FeedbackCapabilityMatchmaking name="MatchFeedback" />
              <DeriveStepFromCapability name="DeriveStep" />
              <CheckConstraints name="CheckConstraints" />
              <RequestTransport name="RequestTransport" FromStation="{config.Agent.ModuleName}" ToStation="{TransportTarget}" />
              <EvaluateRequestTransportResponse name="EvalTransport" />
              <FeasibilityCheck name="FeasibilityCheck" />
              <SchedulingExecute name="RunScheduling" Capability="{MatchedCapability}" />
              <SchedulingFeedback name="SchedulingFeedback" />
              <CheckScheduleFeasibility name="CheckScheduleFeasibility" />
              <CalculateOffer name="CalculateOffer" />
              <SendOffer name="SendOffer" ReceiverId="ProductAgent" />
              <UpdateMachineSchedule name="UpdateSchedule" ModuleId="{config.Agent.ModuleName}" />
            </Sequence>
            <SendPlanningRefusal name="SendRefusal" Reason="{RefusalReason}" ReceiverId="ProductAgent" />
          </Fallback>
        </Repeat>

        <Repeat name="OfferResponseLoop" num_cycles="-1">
          <Sequence name="OfferResponseSequence">
            <ReceiveOfferMessage name="ReceiveOfferMessage" />
            <AwaitOfferDecision name="AwaitOfferDecision" TimeoutMs="2000" />
            <ApplyOfferDecision name="ApplyOfferDecision" />
          </Sequence>
        </Repeat>

        <Repeat name="DispatchLoop" num_cycles="-1">
          <Fallback name="DispatchOrIdle">
            <Sequence name="DispatchIfReady">
              <SelectSchedulableAction name="SelectSchedulableAction" LeadTimeSeconds="0" />
              <SendSkillRequest name="SendSkillRequest" ModuleId="{config.Agent.ModuleName}" />
              <AwaitSkillResponse name="AwaitSkillResponse" ModuleId="{config.Agent.ModuleName}" TimeoutMs="10000" />
              <ApplySkillResponse name="ApplySkillResponse" />
              <Wait name="DispatchThrottle" DelayMs="200" />
            </Sequence>
            <Wait name="IdleWait" DelayMs="500" />
          </Fallback>
        </Repeat>
      </Parallel>
    </Sequence>
  </BehaviorTree>

  <TreeNodesModel>
    <Decorator ID="RetryUntilSuccess">
      <input_port name="numAttempts" default="-1"/>
      <input_port name="delayMs" default="1000"/>
    </Decorator>
    <Action ID="ConnectToMessagingBroker">
      <input_port name="BrokerHost"/>
      <input_port name="BrokerPort"/>
      <input_port name="DefaultTopic"/>
      <input_port name="TimeoutMs"/>
      <input_port name="ClientId"/>
    </Action>
    <Action ID="SetBlackboardValue">
      <input_port name="Key" />
      <input_port name="Value" />
      <input_port name="ValueType" default="string" />
    </Action>
    <Action ID="RegisterSubHolon" />
    <!-- LoadProductionPlan removed for PlanningAgent: plan should be provided by external planner -->
    <Action ID="SelectNextAction"/>
    <Action ID="SendSkillRequest">
      <input_port name="ModuleId"/>
    </Action>
    <Action ID="CapabilityMatchmaking">
      <input_port name="RequiredCapability"/>
    </Action>
    <Action ID="ReceiverRequestForOffer">
      <input_port name="RequiredCapability"/>
    </Action>
    <Action ID="FeedbackCapabilityMatchmaking"/>
    <Action ID="DeriveStepFromCapability"/>
    <Action ID="CheckConstraints"/>
    <Action ID="FeasibilityCheck"/>
    <Action ID="SchedulingExecute">
      <input_port name="Capability"/>
    </Action>
    <Action ID="SchedulingFeedback"/>
    <Action ID="CalculateOffer"/>
    <Action ID="SendOffer">
      <input_port name="ReceiverId"/>
    </Action>
    <Action ID="ReceiveOfferMessage"/>
    <Action ID="SendPlanningRefusal">
      <input_port name="ReceiverId"/>
      <input_port name="Reason"/>
    </Action>
    <Action ID="UpdateMachineSchedule">
      <input_port name="ModuleId"/>
    </Action>
    <Action ID="RequestTransport">
      <input_port name="FromStation"/>
      <input_port name="ToStation"/>
    </Action>
    <Action ID="EvaluateRequestTransportResponse"/>
    <Action ID="CheckScheduleFeasibility"/>
    <Action ID="AwaitOfferDecision">
      <input_port name="TimeoutMs" default="2000"/>
    </Action>
    <Action ID="ApplyOfferDecision"/>
    <Action ID="DispatchScheduledSteps"/>
    <Action ID="SelectSchedulableAction">
      <input_port name="LeadTimeSeconds" default="0"/>
    </Action>
    <Action ID="Wait">
      <input_port name="DelayMs" default="1000"/>
    </Action>
    <Action ID="AwaitSkillResponse">
      <input_port name="ModuleId"/>
      <input_port name="TimeoutMs" default="200"/>
    </Action>
    <Action ID="ApplySkillResponse"/>
  </TreeNodesModel>
</root>
