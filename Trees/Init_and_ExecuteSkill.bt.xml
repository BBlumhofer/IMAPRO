<?xml version="1.0" encoding="UTF-8"?>
<BehaviorTree>
  <Root name="ModuleInitAndExecuteSkill">
    <Sequence name="InitAndExecuteSequence">
      
      <!-- ==================== SCHRITT 1: MQTT BROKER VERBINDUNG ==================== -->
      <RetryUntilSuccess name="MqttConnectRetry" numAttempts="-1" delayMs="5000">
        <Sequence name="MqttConnectSequence">
          <SendLogMessage 
            name="LogMqttAttempt"
            LogLevel="INFO"
            Message="Attempting MQTT connection..."
            Topic="{AgentId}/logs" />
          
          <ConnectToMessagingBroker 
            name="ConnectMqtt"
            BrokerHost="localhost"
            BrokerPort="1883"
            DefaultTopic="factory/agents/messages"
            TimeoutMs="10000" />
          
          <SendLogMessage 
            name="LogMqttConnected"
            LogLevel="INFO"
            Message="MQTT Broker connected successfully"
            Topic="{AgentId}/logs" />
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 2: CONFIG ALS MQTT LOG SENDEN ==================== -->
      <Sequence name="SendConfigSequence">
        <SendLogMessage 
          name="LogConfigStart"
          LogLevel="INFO"
          Message="Sending agent configuration..."
          Topic="{AgentId}/logs" />
        
        <SendConfigAsLog name="SendConfig" />
        
        <SendLogMessage 
          name="LogConfigSent"
          LogLevel="INFO"
          Message="Agent configuration sent successfully"
          Topic="{AgentId}/logs" />
      </Sequence>
      
      <!-- ==================== SCHRITT 3: OPC UA VERBINDUNG MIT RETRY ==================== -->
      <RetryUntilSuccess name="OpcUaConnectRetry" numAttempts="-1" delayMs="3000">
        <Sequence name="OpcUaConnectSequence">
          <SendLogMessage 
            name="LogOpcUaAttempt"
            LogLevel="INFO"
            Message="Attempting OPC UA connection..."
            Topic="{AgentId}/logs" />
          
          <ConnectToModule 
            name="ConnectOPC"
            Endpoint="{config.OPCUA.Endpoint}"
            TimeoutMs="30000" />
          
          <SendLogMessage 
            name="LogOpcUaConnected"
            LogLevel="INFO"
            Message="OPC UA connected successfully"
            Topic="{AgentId}/logs" />
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 4: MODUL LOCKEN MIT RETRY + ÜBERWACHUNG ==================== -->
      <RetryUntilSuccess name="LockRetry" numAttempts="-1" delayMs="2000">
        <Sequence name="LockAndVerifySequence">
          <SendLogMessage 
            name="LogLockAttempt"
            LogLevel="INFO"
            Message="Attempting to lock module..."
            Topic="{AgentId}/logs" />
          
          <Fallback name="LockOrWait">
            <Sequence name="TryLockSequence">
              <LockResource 
                name="LockModule"
                ModuleName="ScrewingStation"
                ResourceId="{config.Agent.ModuleId}"
                TimeoutSeconds="30" />
              
              <Wait name="WaitAfterLock" DelayMs="500" />
              
              <CheckLockStatus 
                name="VerifyLock"
                ModuleName="ScrewingStation" />
              
              <SendLogMessage 
                name="LogLocked"
                LogLevel="INFO"
                Message="Module locked and verified successfully"
                Topic="{AgentId}/logs" />
            </Sequence>
            
            <Sequence name="LockFailedSequence">
              <SendLogMessage 
                name="LogWaitingForUnlock"
                LogLevel="WARNING"
                Message="Waiting for Module to be unlocked"
                Topic="{AgentId}/logs" />
              
              <Condition name="AlwaysFail">
                <BlackboardCondition 
                  Key="__never_exists__" 
                  ExpectedValue="true" />
              </Condition>
            </Sequence>
          </Fallback>
        </Sequence>
      </RetryUntilSuccess>
      
      <!-- ==================== SCHRITT 5: STARTUP SKILL STARTEN ==================== -->
      <Sequence name="StartupSequence">
        <Sequence name="PreStartupLockCheck">
          <SendLogMessage 
            name="LogPreStartupCheck"
            LogLevel="INFO"
            Message="Verifying lock before starting skill..."
            Topic="{AgentId}/logs" />
          
          <CheckLockStatus 
            name="CheckLockBeforeStartup"
            ModuleName="ScrewingStation" />
        </Sequence>
        
        <Sequence name="ExecuteStartupSkill">
          <SendLogMessage 
            name="LogStartupBegin"
            LogLevel="INFO"
            Message="Starting module with StartupSkill..."
            Topic="{AgentId}/logs" />
          
          <ExecuteSkill 
            name="ExecuteStartup"
            ModuleName="ScrewingStation"
            SkillName="StartupSkill"
            WaitForCompletion="false"
            TimeoutSeconds="60"
            ResetBeforeIfHalted="true" />
          
          <SendLogMessage 
            name="LogStartupComplete"
            LogLevel="INFO"
            Message="StartupSkill started successfully (Running)"
            Topic="{AgentId}/logs" />
        </Sequence>
      </Sequence>
      
      <!-- ==================== SCHRITT 6: STORAGE AUSLESEN ==================== -->
      <Sequence name="ReadStorageSequence">
        <SendLogMessage 
          name="LogStorageReadStart"
          LogLevel="INFO"
          Message="Reading storage component..."
          Topic="{AgentId}/logs" />
        
        <ReadStorage 
          name="ReadModuleStorage"
          ModuleName="ScrewingStation" />
        
        <SendLogMessage 
          name="LogStorageReadComplete"
          LogLevel="INFO"
          Message="Storage component read successfully"
          Topic="{AgentId}/logs" />
      </Sequence>
      
      <!-- ==================== SCHRITT 7: SCREW SKILL AUSFÜHREN (MIT SUBTREE) ==================== -->
      <Sequence name="ExecuteScrewSkillSequence">
        
        <SendLogMessage 
          name="LogScrewSkillPreparation"
          LogLevel="INFO"
          Message="Preparing to execute Screw skill..."
          Topic="{AgentId}/logs" />
        
        <!-- SUBTREE: ExecuteSkill mit Pre-Checks -->
        <Sequence name="ExecuteSkillWithChecks">
          
          <!-- Pre-Check 1: Lock-Status prüfen -->
          <Sequence name="PreCheckLock">
            <SendLogMessage 
              name="LogCheckingLock"
              LogLevel="DEBUG"
              Message="Checking lock status before skill execution..."
              Topic="{AgentId}/logs" />
            
            <CheckLockStatus 
              name="CheckLockBeforeScrew"
              ModuleName="ScrewingStation" />
          </Sequence>
          
          <!-- Pre-Check 2: StartupSkill-Status prüfen -->
          <Sequence name="PreCheckStartup">
            <SendLogMessage 
              name="LogCheckingStartup"
              LogLevel="DEBUG"
              Message="Checking StartupSkill status before skill execution..."
              Topic="{AgentId}/logs" />
            
            <CheckStartupSkillStatus 
              name="CheckStartupBeforeScrew"
              ModuleName="ScrewingStation" />
          </Sequence>
          
          <!-- Pre-Checks erfolgreich -> Skill starten -->
          <Sequence name="ExecuteScrewSkill">
            <SendLogMessage 
              name="LogScrewSkillStart"
              LogLevel="INFO"
              Message="Starting Screw skill with ProductId=HelloWorld"
              Topic="{AgentId}/logs" />
            
            <ExecuteSkill 
              name="ExecuteScrew"
              ModuleName="ScrewingStation"
              SkillName="Screw"
              Parameters="ProductId=HelloWorld"
              TimeoutSeconds="120"
              ResetBeforeIfHalted="true" />
            
            <SendLogMessage 
              name="LogScrewSkillComplete"
              LogLevel="INFO"
              Message="Screw skill completed successfully"
              Topic="{AgentId}/logs" />
            
            <!-- TODO: FinalResultData auslesen und loggen -->
            <SendLogMessage 
              name="LogScrewSkillResultData"
              LogLevel="INFO"
              Message="Screw skill FinalResultData: {Context.ScrewSkillResult}"
              Topic="{AgentId}/logs" />
          </Sequence>
        </Sequence>
        
      </Sequence>
      
      <!-- ==================== FINALE STATUS-NACHRICHT ==================== -->
      <SendLogMessage 
        name="LogAllComplete"
        LogLevel="INFO"
        Message="Module initialization and Screw skill execution completed successfully"
        Topic="{AgentId}/logs" />
      
    </Sequence>
  </Root>
</BehaviorTree>
